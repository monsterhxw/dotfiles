set -g default-terminal "tmux-256color"
set -as terminal-features ",*:RGB"
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM
set -g allow-passthrough on

# set -s set-clipboard on # defualt value: external

set -g history-limit 6000
set -g mouse on
set -g focus-events on
set -sg escape-time 10

set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on

set -g mode-keys vi # Copy-mode, View-mode, Choose-mode
set -g status-keys vi # tmux Command Prompt

bind 'r' source-file "$HOME/.config/tmux/tmux.conf" \; display-message "Config reloaded"
bind 'w' choose-tree -Z

# bind -n 'M-J' previous-window
# bind -n 'M-K' next-window
bind 'Tab' last-window
bind '=' select-layout -E # Equalize all panes size

unbind '"'
bind '-' split-window -v -c "#{pane_current_path}"
unbind '%'
bind '_' split-window -h -c "#{pane_current_path}"

bind 'h' select-pane -L
bind 'j' select-pane -D
bind 'k' select-pane -U
bind 'l' select-pane -R
bind -r 'H' resize-pane -L 5
bind -r 'J' resize-pane -D 5
bind -r 'K' resize-pane -U 5
bind -r 'L' resize-pane -R 5
unbind '{'
bind '<' swap-pane -U
unbind '}'
bind '>' swap-pane -D

bind -T copy-mode-vi 'v' send-keys -X begin-selection
bind -T copy-mode-vi 'C-v' send-keys -X rectangle-toggle \; send-keys -X begin-selection
bind -T copy-mode-vi 'y' send-keys -X copy-pipe # yank (stay in copy-mode)
bind -T copy-mode-vi 'Y' send-keys -X copy-pipe-and-cancel \; paste-buffer # yank and paste to command prompt
unbind -T copy-mode-vi MouseDragEnd1Pane
bind -T copy-mode-vi WheelUpPane select-pane \; send-keys -X -N 2 scroll-up # smoother scrolling
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down # smoother scrolling

bind 'C-l' send-keys 'clear' 'Enter' \; clear-history # Clear screen and scrollback buffer

# Theme
source-file "$HOME/.config/tmux/themes/theme.conf"

# Plugins
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.config/tmux/plugins"

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'christoomey/vim-tmux-navigator'

set -g @continuum-restore 'on'
set -g @continuum-save-interval '20'
set -g @resurrect-dir "$HOME/.config/tmux/resurrect"
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
# set -g @resurrect-strategy-vim 'session'
# 在 tmux-resurrect 保存会话后清理旧的 resurrect 文件，只保留最近的 5 个文件
set -g @resurrect-hook-post-save-all '\
         find "$HOME/.config/tmux/resurrect" -name "tmux_resurrect_*.txt" -type f -print \
         | sort -r \
         | tail -n +6 \
         | xargs /usr/local/bin/trash'

# see https://github.com/sainnhe/tmux-fzf/issues/6
TMUX_FZF_MENU=\
"switch pane\n$HOME/.config/tmux/plugins/tmux-fzf/scripts/pane.sh switch\n"\
"attach session\n$HOME/.config/tmux/plugins/tmux-fzf/scripts/session.sh attach\n"\
"rename window\n$HOME/.config/tmux/plugins/tmux-fzf/scripts/window.sh rename\n"
# bind-key "C-l" run-shell -b "$HOME/.config/tmux/plugins/tmux-fzf/scripts/pane.sh switch"

set -g @vim_navigator_mapping_left "S-Left"
set -g @vim_navigator_mapping_down "S-Down"
set -g @vim_navigator_mapping_up "S-Up"
set -g @vim_navigator_mapping_right "S-Right"
set -g @vim_navigator_mapping_prev "C-\\"
set -g @vim_navigator_prefix_mapping_clear_screen ""

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'
